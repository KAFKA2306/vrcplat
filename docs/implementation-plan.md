# 実装計画

## 目的と適用範囲

- `docs/requirement_draft.md` に定義された 3 スプリント構成を起点に、プロトタイプから本運用までの
  技術・UX 作業を横断的に可視化する。
- サービス層、共有パッケージ、ダッシュボード UI の依存関係と責任範囲を整理し、着手順序と検証観点を
  明文化する。
- 進捗会議と PR 説明で「どの項目が計画上どこに位置しているか」を即時追跡できる状態を維持する。

## 運用方針

- 必ず縦切りのバリュースライスで進め、同意・データ処理・UI の整合性を各スプリントで検証する。
- ドメイン契約は `packages/shared` で一元管理し、サービス／アプリは型とスキーマを参照するだけにする。
- 顧客向けフローと技術仕様は `docs/` に集約し、決定や変更は日付付きで本書へ追記する。

## リリーススケジュール（暫定）

| スプリント | テーマ | 主な成果物 |
| --- | --- | --- |
| S1 | 同意とプレゼンス | アイデンティティ基盤、同意管理、VRCX インポート、ダッシュボード基盤 |
| S2 | 購入とアバターメタ | 購入取込・重複解消、アバター差分メタ、ロードアウト編集 |
| S3 | イベントと多重投稿 | 集会リンク、マルチポスト、推薦 v1、意味検索 |

## エピック別タスク

### アイデンティティと同意（S1）

- **services/identity**
  - Discord / Google / X OAuth2 連携、DID 発行、セッション Cookie 回転。
  - 同意スコープ CRUD、監査ログ API、エクスポート／削除ジョブのキュー制御。
- **packages/shared/auth**
  - セッション・同意向け TypeScript クライアント公開、Vitest 契約テスト整備。
- **apps/dashboard**
  - セッションガード済み。`/privacy` の同意トグルUIをベータ接続（APIは今後のサービス実装待ち）。
  - データエクスポート／削除モーダル、ヘッダーへの Beacon 状況表示は次フェーズ。
- **検証**
  - サービス単体テストでスコープ制御と監査ログを確認。
  - Playwright で「サインイン → 同意更新 → エクスポート」フローを自動化。

### プレゼンス取込（S1）

- **services/presence**
  - `POST /presence/ping`、`GET /presence/me`、`GET /presence/friends` を実装。
  - VRCX インポータと OSC トークン認証、重複除外ロジック。
- **packages/shared/contracts**
  - プレゼンスセッションスキーマ（実装済み）とフレンド同意型を公開。
  - `tests/contracts/` に JSON Schema スナップショットを生成。
- **apps/dashboard**
  - 「Now / Recent / Next」パネルを実データに接続し、同意ステータスを描画。
  - Companion 未連携時の空状態や導線を整備。
- **検証**
  - 匿名化済みペイロードを `docs/assets/` に格納し再現テストを実施。
  - Playwright で VRCX JSON アップロードと履歴表示を確認。

### 購入集約（S2）

- **services/purchases**
  - BOOTH / Shopify / Gumroad / Patreon / fanbox の Webhook 受信機を構築。
  - メール転送インジェスタ（SES/Gmail）のスタブ、通貨正規化と重複解消ジョブ。
- **packages/shared/contracts**
  - `PurchaseRecord` に重複フラグや CVI / UEI 連携フィールドを追加。
- **apps/dashboard**
  - フィルタ付き購入リスト、領収書プレビュー、ロードアウト紐付け UI。
  - CVI / UEI 指標ウィジェットと検証メモ表示。
- **検証**
  - 匿名領収書で契約テストと Vitest 重複シナリオ。
  - Playwright でストア横断フィルタリングを確認。

### アバター差分とロードアウト（S2）

- **services/avatar-diff**
  - バージョン・差分・クレジット自動生成 API、ライセンス URL 監査ジョブ。
- **apps/dashboard**
  - アバタータイムライン、差分ビューワ、購入連携ロードアウトエディタ。
  - クレジットカード生成とシェア導線。
- **検証**
  - 差分メタのスナップショットテスト、VRChat ログの同意タグ付け確認。

### イベント・投稿・推薦（S3）

- **services/events**
  - 集会カード CRUD、招待リンク発行、合流率トラッキング。
- **services/posts**
  - マルチポストスケジューラ、リトライログ、外部 API 失敗ハンドリング。
- **services/search**
  - 埋め込み検索＋全文検索のハイブリッド構成。同意スコープ考慮フィルタ。
- **apps/dashboard**
  - イベント作成ウィザード、Join now CTA、マルチポストコンポーザ。
  - グローバル検索バー、タイプ別ハイライト。
- **検証**
  - イベントペイロード契約テスト、Playwright で投稿スケジュール確認。
  - Lighthouse CI で LCP ≤ 2.5 s を監視。

## 横断タスク

- **観測性**: 各サービスから OpenTelemetry を送信し、ログ基盤へ集約。
- **プライバシー**: エクスポート／削除要求から 60 秒以内にキャッシュを無効化。
- **ローカライズ**: ダッシュボードに ja / en の i18n 架台を導入（S2 前）。
- **アクセシビリティ**: Axe による自動検査と、モーダルのキーボードトラップ点検。
- **ドキュメント**: `docs/new-user-guide.md` と `docs/assets/` をリリースごとに更新。

## 依存関係と順序

- ダッシュボード側の同意 UI は identity サービスと同意 API 完了後に本結線する。
- プレゼンス表示は Beacon トークン・フレンド同意同期・履歴インポータが前提。
- 購入 UI は重複解消と通貨正規化完了後に実装し、冪等性が担保された状態で公開。
- ロードアウト機能は購入紐付けとプレゼンスメタを利用するため、双方のスキーマ確定を待つ。
- イベント／投稿／推薦は `event:write`、`post:write` スコープと検索サービスの API を前提とする。

## 進捗管理と更新ルール

- 本ドキュメントは週次の PM/Eng 合同レビュー直後に更新し、更新日を各節末尾に記す。
- PR 説明には該当項目のセクションリンクを含め、完了後はチェック済みコメントを追記する。
- スプリントボード（Issue Tracker）と本書の節を 1:1 で対応付け、ステータス変更時に双方を同期する。
- 変更前後の合意事項は `docs/` 配下で追跡し、不要な派生メモは作成しない。

## 品質維持フック

- `npx markdownlint-cli2 docs/**/*.md` と `npx cspell docs` をコミット前に必ず実行する。
- 各スプリント末に契約テスト・E2E・パフォーマンス指標を表形式で追記し、差異があれば原因と対策を
  メモとして残す。
- 重大なリスク（プライバシー、依存 API 改定など）は「目的と適用範囲」節直下に警告ブロックを追加し、
  解消まで残す。

*更新履歴: 2025-10-28 作成 / 2025-10-28 同意UI反映*
